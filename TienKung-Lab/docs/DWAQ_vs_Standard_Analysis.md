# DWAQ ç®—æ³•åˆ†æä¸åŸŸéšæœºåŒ–å¯¹æ¯”

## 1. DWAQ vs æ ‡å‡† Actor-Criticï¼šä¸ºä»€ä¹ˆæ›´é€‚åˆä¸Šå°é˜¶ï¼Ÿ

### 1.1 DWAQ æ ¸å¿ƒä¼˜åŠ¿

**Î²-VAE ä¸Šä¸‹æ–‡ç¼–ç å™¨**èƒ½å¤Ÿä»è§‚æµ‹å†å²ä¸­æ¨æ–­éšè—çš„ç¯å¢ƒçŠ¶æ€ï¼š

```
ä¼ ç»Ÿ Actor-Critic:
  è§‚æµ‹ â†’ Actor â†’ åŠ¨ä½œ
  
DWAQ:
  è§‚æµ‹å†å²(5å¸§) â†’ Î²-VAEç¼–ç å™¨ â†’ é€Ÿåº¦(3) + æ½œåœ¨çŠ¶æ€(16)
                                       â†“
  å½“å‰è§‚æµ‹ + æ½œåœ¨ç¼–ç (19) â†’ Actor â†’ åŠ¨ä½œ
```

### 1.2 ä¸Šå°é˜¶åœºæ™¯çš„å…³é”®æŒ‘æˆ˜

| æŒ‘æˆ˜ | æ ‡å‡† AC çš„å›°éš¾ | DWAQ çš„è§£å†³æ–¹æ¡ˆ |
|------|---------------|----------------|
| **é«˜åº¦å˜åŒ–** | å•å¸§è§‚æµ‹æ— æ³•æ„ŸçŸ¥å°é˜¶é«˜åº¦è¶‹åŠ¿ | ä»å†å²æ¨æ–­å³å°†åˆ°æ¥çš„é«˜åº¦å˜åŒ– |
| **æ‘©æ“¦åŠ›å˜åŒ–** | æ¯æ­¥æ‘©æ“¦åŠ›éšæœºï¼Œæ— æ³•é¢„æµ‹ | ä»æ¥è§¦å†å²æ¨æ–­å½“å‰åœ°å½¢æ‘©æ“¦ç‰¹æ€§ |
| **åŠ¨æ€å¹³è¡¡** | éœ€è¦é¢„æµ‹æ€§è°ƒæ•´ï¼Œå•å¸§ä¿¡æ¯ä¸è¶³ | æ½œåœ¨ç¼–ç åŒ…å«é€Ÿåº¦è¶‹åŠ¿å’Œå¹³è¡¡çŠ¶æ€ |
| **ç›²èµ°èƒ½åŠ›** | Height scan ä¾èµ–å¯¼è‡´ sim2real gap | Actor ç›²èµ°ï¼Œä»…ä¾èµ–æœ¬ä½“æ„ŸçŸ¥ |

### 1.3 DWAQ çš„ç›²èµ°æœºåˆ¶

```
Critic (ç‰¹æƒè§‚æµ‹):
  - çœŸå®é€Ÿåº¦ (3 dim)
  - Height scan (187 dim)
  - Feet ä½ç½®/é€Ÿåº¦ (12 dim)
  - æ¥è§¦åŠ› (6 dim)
  â†“ ç”¨äºä»·å€¼ä¼°è®¡å’Œé€Ÿåº¦ç›‘ç£

Actor (ç›²èµ°):
  - è§’é€Ÿåº¦ (3)
  - é‡åŠ›æŠ•å½± (3)
  - æŒ‡ä»¤ (3)
  - å…³èŠ‚ä½ç½® (29)
  - å…³èŠ‚é€Ÿåº¦ (29)
  - ä¸Šä¸€æ­¥åŠ¨ä½œ (29)
  â†“ 66 ç»´æœ¬ä½“æ„ŸçŸ¥

Î²-VAE ç¼–ç å™¨:
  - è¾“å…¥: è§‚æµ‹å†å² (66Ã—5 = 330 dim)
  - è¾“å‡º: é€Ÿåº¦ä¼°è®¡(3) + æ½œåœ¨çŠ¶æ€(16) = 19 dim
  - ç›‘ç£: Critic æä¾›çš„çœŸå®é€Ÿåº¦
  â†“ æ¨æ–­éšè—ç¯å¢ƒä¿¡æ¯

Actor æœ€ç»ˆè¾“å…¥:
  - æœ¬ä½“æ„ŸçŸ¥ (66) + æ½œåœ¨ç¼–ç  (19) = 85 dim
  âœ“ åŒ…å«ç¯å¢ƒçŠ¶æ€æ¨æ–­ï¼Œæ— éœ€ height scan
```

**å…³é”®ä¼˜åŠ¿**: Actor ä¸ä¾èµ–è§†è§‰/æ¿€å…‰é›·è¾¾ï¼Œä»…é€šè¿‡æœ¬ä½“æ„ŸçŸ¥+å†å²æ¨æ–­å³å¯åº”å¯¹å¤æ‚åœ°å½¢ï¼

---

## 2. åŸŸéšæœºåŒ–å¯¹æ¯”åˆ†æ

### 2.1 åŸç‰ˆ DreamWaQ (Isaac Gym) åŸŸéšæœºåŒ–

```python
class domain_rand:
    rand_interval_s = 4  # æ¯4ç§’é‡æ–°éšæœºåŒ–
    
    # æ‘©æ“¦åŠ›éšæœºåŒ–
    randomize_friction = True
    friction_range = [0.2, 1.25]  # è¾ƒå®½èŒƒå›´
    
    # è´¨é‡éšæœºåŒ–
    randomize_base_mass = True
    added_mass_range = [-1.0, 2.0]  # -1kg ~ +2kg
    
    # è´¨å¿ƒåç§»éšæœºåŒ–
    randomize_com_displacement = True
    com_displacement_range = [-0.05, 0.05]  # Â±5cm
    
    # ç”µæœºå¼ºåº¦éšæœºåŒ–
    randomize_motor_strength = True
    motor_strength_range = [0.9, 1.1]  # Â±10%
    
    # PD æ§åˆ¶å™¨éšæœºåŒ–
    randomize_Kp_factor = True
    Kp_factor_range = [0.9, 1.1]  # Â±10%
    randomize_Kd_factor = True
    Kd_factor_range = [0.9, 1.1]  # Â±10%
    
    # å¤–åŠ›æ¨åŠ¨ (ç¦ç”¨)
    push_robots = False
    push_interval_s = 15
    max_push_vel_xy = 1.0
```

### 2.2 å½“å‰ TienKung-Lab (Isaac Lab) åŸŸéšæœºåŒ–

```python
class domain_rand:
    events = EventCfg(
        # ç‰©ç†æè´¨éšæœºåŒ– (å¯åŠ¨æ—¶)
        physics_material = EventTerm(
            mode="startup",
            static_friction_range=(0.6, 1.0),   # æ›´çª„èŒƒå›´
            dynamic_friction_range=(0.4, 0.8),  # æ›´çª„èŒƒå›´
            restitution_range=(0.0, 0.005),
            num_buckets=64,
        ),
        
        # è´¨é‡éšæœºåŒ– (å¯åŠ¨æ—¶)
        add_base_mass = EventTerm(
            mode="startup",
            mass_distribution_params=(-5.0, 5.0),  # æ›´å®½èŒƒå›´: Â±5kg
        ),
        
        # åˆå§‹çŠ¶æ€éšæœºåŒ– (æ¯æ¬¡reset)
        reset_base = EventTerm(
            mode="reset",
            pose_range={
                "x": (-0.5, 0.5), "y": (-0.5, 0.5), 
                "yaw": (-3.14, 3.14)  # å…¨æ–¹å‘
            },
            velocity_range={
                "x": (-0.5, 0.5), "y": (-0.5, 0.5), "z": (-0.5, 0.5),
                "roll": (-0.5, 0.5), "pitch": (-0.5, 0.5), "yaw": (-0.5, 0.5),
            },
        ),
        
        # å…³èŠ‚åˆå§‹åŒ–éšæœºåŒ– (æ¯æ¬¡reset)
        reset_robot_joints = EventTerm(
            mode="reset",
            position_range=(0.5, 1.5),  # 50%-150% é»˜è®¤å€¼
            velocity_range=(0.0, 0.0),
        ),
        
        # å¤–åŠ›æ¨åŠ¨ (é—´éš”è§¦å‘)
        push_robot = EventTerm(
            mode="interval",
            interval_range_s=(10.0, 15.0),
            velocity_range={"x": (-1.0, 1.0), "y": (-1.0, 1.0)},
        ),
    ),
    
    # åŠ¨ä½œå»¶è¿Ÿ
    action_delay = ActionDelayCfg(
        enable=True,  # DWAQ å¯ç”¨
        max_delay=5,
        min_delay=0,
    ),
)
```

### 2.3 å…³é”®å·®å¼‚å¯¹æ¯”

| é¡¹ç›® | åŸç‰ˆ DreamWaQ | å½“å‰ TienKung-Lab | å½±å“ |
|------|--------------|------------------|------|
| **æ‘©æ“¦åŠ›èŒƒå›´** | [0.2, 1.25] | é™æ€[0.6, 1.0] åŠ¨æ€[0.4, 0.8] | âš ï¸ **èŒƒå›´æ›´çª„** - å¯èƒ½é™ä½æ³›åŒ–èƒ½åŠ› |
| **è´¨é‡èŒƒå›´** | [-1, +2] kg | [-5, +5] kg | âœ“ **æ›´å¤§èŒƒå›´** - æ›´å¼ºé²æ£’æ€§ |
| **è´¨å¿ƒåç§»** | âœ“ [-5, 5] cm | âœ— **ç¼ºå¤±** | âš ï¸ **éœ€è¦æ·»åŠ ** - å½±å“å¹³è¡¡è®­ç»ƒ |
| **ç”µæœºå¼ºåº¦** | âœ“ [0.9, 1.1] | âœ— **ç¼ºå¤±** | âš ï¸ **éœ€è¦æ·»åŠ ** - å½±å“æ‰§è¡Œå™¨å»ºæ¨¡ |
| **PDå‚æ•°** | âœ“ Kp/Kd Â±10% | âœ— **ç¼ºå¤±** | âš ï¸ **éœ€è¦æ·»åŠ ** - å½±å“æ§åˆ¶é²æ£’æ€§ |
| **åˆå§‹å§¿æ€** | âœ— å›ºå®š | âœ“ ä½ç½®/å§¿æ€/é€Ÿåº¦å…¨éšæœº | âœ“ **æ›´å¥½** - æ¢ç´¢å¤šæ ·åˆå§‹çŠ¶æ€ |
| **åŠ¨ä½œå»¶è¿Ÿ** | âœ— æ—  | âœ“ [0, 5] æ­¥ | âœ“ **æ›´å¥½** - sim2real å…³é”® |
| **éšæœºåŒ–é¢‘ç‡** | æ¯ 4s | å¯åŠ¨æ—¶/reset | âš ï¸ **å·®å¼‚** - å½±å“é€‚åº”æ€§ |

---

## 3. å»ºè®®çš„åŸŸéšæœºåŒ–å¢å¼º

ä¸ºäº†è¾¾åˆ°åŸç‰ˆ DreamWaQ çš„é²æ£’æ€§ï¼Œå»ºè®®æ·»åŠ ä»¥ä¸‹éšæœºåŒ–ï¼š

```python
# åœ¨ G1DwaqEnvCfg.__post_init__() ä¸­æ·»åŠ :

# 1. è´¨å¿ƒåç§»éšæœºåŒ– (é‡è¦!)
self.domain_rand.events.randomize_com = EventTerm(
    func=mdp.randomize_rigid_body_coms,
    mode="startup",
    params={
        "asset_cfg": SceneEntityCfg("robot", body_names=".*torso.*"),
        "com_range": {"x": (-0.05, 0.05), "y": (-0.05, 0.05), "z": (-0.05, 0.05)},
    },
)

# 2. ç”µæœºå¼ºåº¦éšæœºåŒ– (é‡è¦!)
self.domain_rand.events.randomize_actuator_gains = EventTerm(
    func=mdp.randomize_actuator_gains,
    mode="startup",
    params={
        "asset_cfg": SceneEntityCfg("robot", joint_names=".*"),
        "stiffness_distribution_params": (0.9, 1.1),  # Â±10%
        "damping_distribution_params": (0.9, 1.1),    # Â±10%
        "operation": "scale",
    },
)

# 3. æ‰©å¤§æ‘©æ“¦åŠ›èŒƒå›´ (å¯¹é½åŸç‰ˆ)
self.domain_rand.events.physics_material.params["static_friction_range"] = (0.2, 1.25)
self.domain_rand.events.physics_material.params["dynamic_friction_range"] = (0.15, 1.0)
```

---

## 4. å…³äºåœ°å½¢ MDL æè´¨

### 4.1 MDL æè´¨æ˜¯å¦å½±å“è®­ç»ƒï¼Ÿ

**ä¸å½±å“ç‰©ç†ä»¿çœŸè®­ç»ƒï¼**

MDL (Material Definition Language) æ˜¯ **è§†è§‰æ¸²æŸ“æè´¨**ï¼Œæ§åˆ¶ï¼š
- é¢œè‰²ã€çº¹ç†
- å…‰ç…§åå°„
- è§†è§‰å¤–è§‚

**ç‰©ç†å±æ€§** (å½±å“è®­ç»ƒ) ç”±ä»¥ä¸‹æ§åˆ¶ï¼š
- `physics_material` (æ‘©æ“¦åŠ›ã€å¼¹æ€§)
- `rigid_body_material` (è´¨é‡ã€æƒ¯æ€§)
- `collision properties` (ç¢°æ’å½¢çŠ¶)

### 4.2 éªŒè¯æ–¹å¼

```python
# MDL æè´¨è®¾ç½®ç¤ºä¾‹ (ä»…å½±å“è§†è§‰)
terrain_material = {
    "mdl_path": "OmniPBR.mdl",
    "albedo_color": (0.5, 0.5, 0.5),
    "roughness": 0.8,
    "metallic": 0.0,
}

# ç‰©ç†æè´¨è®¾ç½® (å½±å“è®­ç»ƒ)
physics_material = EventTerm(
    func=mdp.randomize_rigid_body_material,
    params={
        "static_friction_range": (0.2, 1.25),  # è¿™ä¸ªå½±å“è®­ç»ƒ!
        "dynamic_friction_range": (0.15, 1.0),
    },
)
```

**ç»“è®º**: ä½ å¯ä»¥éšæ„è®¾ç½® MDL æè´¨ç¾åŒ–åœºæ™¯ï¼Œä¸ä¼šå½±å“è®­ç»ƒæ•ˆæœã€‚ä½†åŠ¡å¿…æ£€æŸ¥ `physics_material` éšæœºåŒ–é…ç½®ï¼

---

## 5. DWAQ è®­ç»ƒç›‘æ§è¦ç‚¹

### 5.1 å…³é”®æŒ‡æ ‡

| æŒ‡æ ‡ | æœŸæœ›å€¼ | è¯´æ˜ |
|------|-------|------|
| **Loss/autoencoder** | é€æ¸ä¸‹é™ | VAE é‡å»ºå’Œé€Ÿåº¦ä¼°è®¡æŸå¤± |
| **Episode/mean_reward** | é€æ¸ä¸Šå‡ | æ•´ä½“æ€§èƒ½ |
| **Episode/mean_episode_length** | é€æ¸ä¸Šå‡è‡³ max | å­˜æ´»æ—¶é—´ |
| **Train/mean_episode_length** | > 400 æ­¥ (20s) | ç¨³å®šè¡Œèµ° |

### 5.2 Î²-VAE ç›‘æ§

```python
# åœ¨ tensorboard ä¸­å…³æ³¨:
- Loss/autoencoder: VAE æ€»æŸå¤± (vel_MSE + recon_MSE + KL_div)
- æœŸæœ›è¶‹åŠ¿: å‰ 1000 iter å¿«é€Ÿä¸‹é™ï¼Œç„¶åç¨³å®šåœ¨ä½å€¼

# é€Ÿåº¦ä¼°è®¡ç²¾åº¦ (éœ€è¦é¢å¤– logging):
vel_error = torch.norm(code_vel - vel_target, dim=-1).mean()
# æœŸæœ›: < 0.1 m/s (è®­ç»ƒåæœŸ)
```

### 5.3 è®­ç»ƒé˜¶æ®µ

1. **å‰ 500 iter**: VAE å­¦ä¹ é€Ÿåº¦ä¼°è®¡
   - autoenc_loss å¿«é€Ÿä¸‹é™
   - episode_length è¾ƒçŸ­ (< 200)

2. **500-2000 iter**: è”åˆä¼˜åŒ–
   - autoenc_loss ç¨³å®š
   - episode_length é€æ¸å¢é•¿

3. **2000+ iter**: å¾®è°ƒé˜¶æ®µ
   - mean_reward ç¨³å®šä¸Šå‡
   - å¼€å§‹çˆ¬æ¥¼æ¢¯æˆåŠŸç‡æå‡

---

## 6. æ€»ç»“ä¸è¡ŒåŠ¨å»ºè®®

### âœ… DWAQ ä¼˜åŠ¿ç¡®è®¤

**DWAQ ç¡®å®æ›´é€‚åˆä¸Šå°é˜¶**ï¼Œå› ä¸ºï¼š
1. Î²-VAE èƒ½ä»å†å²æ¨æ–­åœ°å½¢ç‰¹æ€§
2. Actor ç›²èµ°èƒ½åŠ›å¼ºï¼Œsim2real gap å°
3. æ½œåœ¨ç¼–ç åŒ…å«é€Ÿåº¦è¶‹åŠ¿ï¼Œé¢„æµ‹æ€§æ›´å¥½

### âš ï¸ å½“å‰éœ€è¦æ”¹è¿›

1. **åŸŸéšæœºåŒ–ä¸å®Œæ•´** - ç¼ºå°‘è´¨å¿ƒåç§»ã€ç”µæœºå¼ºåº¦ã€PD å‚æ•°éšæœºåŒ–
2. **æ‘©æ“¦åŠ›èŒƒå›´åçª„** - å»ºè®®æ‰©å¤§åˆ° [0.2, 1.25]
3. **ç¼ºå°‘å‘¨æœŸæ€§éšæœºåŒ–** - åŸç‰ˆæ¯ 4s é‡æ–°éšæœºï¼Œå½“å‰ä»… startup/reset

### ğŸ¯ å»ºè®®æ“ä½œ

```python
# 1. ç«‹å³æ·»åŠ ç¼ºå¤±çš„åŸŸéšæœºåŒ– (è§ç¬¬3èŠ‚)
# 2. æ‰©å¤§æ‘©æ“¦åŠ›èŒƒå›´
# 3. è®­ç»ƒè‡³å°‘ 5000 iter è§‚å¯Ÿæ”¶æ•›
# 4. ç›‘æ§ autoenc_lossï¼Œç¡®ä¿ VAE æ­£å¸¸å­¦ä¹ 
# 5. MDL æè´¨éšæ„è®¾ç½®ï¼Œä¸å½±å“è®­ç»ƒ
```

**é¢„æœŸæ•ˆæœ**: è¡¥å…¨åŸŸéšæœºåŒ–åï¼ŒDWAQ åœ¨å°é˜¶åœºæ™¯çš„æ³›åŒ–èƒ½åŠ›åº”æ˜¾è‘—ä¼˜äºæ ‡å‡† ACï¼
